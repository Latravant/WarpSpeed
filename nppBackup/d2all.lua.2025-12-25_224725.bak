_addon.name = 'D2all'
_addon.author = 'Latravant (Ragnarok)'
_addon.commands = {'d2all','D2All'}
_addon.language = 'English'

require('tables')
require('strings')
require('logger')

res = require('resources')


windower.register_event('addon command', function(command, ...)
    command = command and command:lower()

    local party = T(windower.ffxi.get_party())
    local zone = windower.ffxi.get_info().zone

    if command == 'd2all' then	
		local party = windower.ffxi.get_party()
		for i = 1,5 do
			local member = party['p' .. i]
			if member.mob.id then
				if member.mob.id == player_id then return true end
			end
		end
		return false
	end
end)

function warp_party(spell,eventArgs)
	local player = windower.ffxi.get_player()
	local spell_recasts = windower.ffxi.get_spell_recasts()
	if player.main_job == 'BLM' or player.sub_job == 'BLM' and spell_recasts[262] < spell_latency then
		windower.chat.input('/ma "Warp ii" '..member..'') return true
	else 
		add_to_chat(123,'Unable to cast warp:'..player.main_job..'/'..player.sub_job..'')
		return 
	end	
end	

function check_cost(spell, spellMap, eventArgs)
	local spellCost = actual_cost(spell)

	if spell.action_type == 'Magic' and player.mp < spellCost then
		if stepdown(spell, eventArgs) then
			return true
		else
			add_to_chat(123,'Abort: '..spell.english..' costs more MP. ('..player.mp..'/'..spellCost..')')
			cancel_spell()
			eventArgs.cancel = true
			return true
		end
	else
		return false
	end
end

function check_warps(spell, spellMap, eventArgs)
	if spell.target.type == 'SELF' and spell.english:contains('Warp') then
		if world.area == 'Hazhalm Testing Grounds' and player.inventory['Glowing Lamp'] then
			cancel_spell()
			eventArgs.cancel = true
			add_to_chat(123,"Abort: Drop your Glowing Lamp, you don't want to lose your plasm!")
			return true
		end
	end
	return false
end
	
windower.register_event('load', function()
    windower.send_command('alias d2all lua c d2all')
end)

windower.register_event('unload', function()
    windower.send_command('unalias d2all')
end)